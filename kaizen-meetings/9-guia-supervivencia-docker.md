---
type: slide
slideOptions:
  transition: slide
  theme: white
---

## guía de supervivencia con docker

### kaizen meetings

#### pedro-presenta@cas.cat

[CC BY-SA 4.0](https://creativecommons.org/licenses/by-sa/4.0/)

---

#### mochila para territorio docker (1/2)

- git: control de versiones
- yaml: lo usa docker-compose. formato "devops" tipo json y fácil de escribir (y de liarla)
    - de interés: noyaml.com
- docker: :8ball:
- docker-compose: interacción entre dockers
    - de interés: https://eng.uber.com/microservice-architecture/

---

#### mochila para territorio docker (2/2)

- nginx reverse proxy: servidor web robusto y de confianza (como un cortafuegos para HTTP)
- iptables: cortafuegos legacy
- `tcpdump -i any port 3000 -n`: inspeccionar paquetes en puerto 3000 sin resolución DNS
- `curl http://localhost:3000`: consultar web por terminal
- `ncdu /`: analiza espacio en disco

---

#### ejemplo hedgedoc pad.example.com (1/2)

hedgedoc.org és el fork comunitario de hackmd.io, un pad colaborativo con muchas características tales como esta presentación

instalación método docker: https://docs.hedgedoc.org/setup/docker/#alpine-based-version

```
git clone \
  https://github.com/hedgedoc/container.git \
  hedgedoc-container
cd hedgedoc-container
docker-compose up
```

o `docker-compose up -d` para background mode

---

#### ejemplo hedgedoc pad.example.com (2/2)

hay muchos webservers

un reverse proxy es un intermediario especializado en gestión de tráfico HTTP/HTTPS. Aprender uno, y redireccionar a las correspondientes peticiones como corresponda

https://docs.hedgedoc.org/guides/reverse-proxy/#nginx

---

#### docker-compose: ejemplo postgresql

variables de entorno para instanciar base de datos

```
services:
  database:
    image: postgres:9.6-alpine   # imagen
    environment:
      - POSTGRES_USER=hedgedoc
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=hedgedoc
    volumes:
      - database:/var/lib/postgresql/data
```

---

#### docker-compose: ejemplo app

app que conecta con la base de datos, y expone puerto 3000 fuera de docker

```
services:
  database:
  # (...)
  app:
    image: quay.io/hedgedoc/hedgedoc:1.7.2
    environment:
      - CMD_DB_URL=postgres://hedgedoc:password@database:5432/hedgedoc
    volumes:
      - uploads:/hedgedoc/public/uploads
    ports:
      - "3000:3000"
```

---

#### docker-compose: volúmenes

Volumes are the preferred mechanism for persisting data generated by and used by Docker containers

https://docs.docker.com/storage/volumes/

en ejemplo anterior, los volúmenes no estaban expuestos, para exponer los volúmenes a nuestro sistema de ficheros:

```
    volumes:
      - ./ruta_relativa_en_mi_pc:/ruta/en/contenedor/docker
```

---

#### docker pid 1: lanzador de entornos

ejemplo ligero (1.23 MB):

`docker run -it --rm busybox`

ejemplo más pesado (114 MB):

`docker run -h debian-test -it -P debian:10 bash`

```
root@debian-test:/# echo $$
```

devuelve 1, porque es el pid 1 (!!)

---

#### docker pid 1 vs LXC, KVM, jails

- LXC,LXD: parecido, pero carga un sistema de boot (tal como systemd, sysvinit, etc.)
- KVM: virtualiza todos los componentes físicos como virtuales, reserva uso de RAM
    - el debate: dos servicios en dos KVM separados, vs 1 KVM con 2 contenedores de pad
- jails (FreeBSD): los contenedores pero bien hechos, frecuentemente un usuario de jails odiará docker
- etc.

---

#### seguridad (1/3): análisis de imágenes vulnerables en dockerhub.com

- the number of newly introduced vulnerabilities on Docker Hub is **rapidly increasing**
- certified images are the most vulnerable
- **official images** are the least vulnerable

https://arxiv.org/pdf/2006.02932.pdf

https://docs.docker.com/docker-hub/official_images/

---

#### Dockerfile sencillo de aplicación

cada instrucción genera una capa

```
FROM debian:buster
COPY . /app
RUN make /app
CMD python /app/app.py
```

*genera* la imagen del Dockerfile:

```
docker build -t mi_imagen .
```

https://docs.docker.com/develop/develop-images/dockerfile_best-practices/

---

#### dockerfile imagen debian

```
FROM scratch
ADD rootfs.tar.xz /
CMD ["bash"]
```

https://github.com/debuerreotype/docker-debian-artifacts/tree/7c8c3447048f6b2866c2c55311606449ea088630/buster

Supported tags and respective Dockerfile links https://hub.docker.com/_/debian

---

#### docker registry

docker hub, docker registry oficial https://hub.docker.com

imágenes oficiales https://hub.docker.com/_/imagen-oficial

despliegue local: https://docs.docker.com/registry/deploying/#run-a-local-registry

crea tus propias imágenes: https://docs.docker.com/develop/develop-images/baseimages/

---

#### seguridad (2/3): firewall

By default, the Docker daemon will expose **[all]** ports on the 0.0.0.0 address, i.e. any address on the host

If you need to add rules which load before Docker’s rules, add them to the DOCKER-USER chain

https://docs.docker.com/network/iptables/

https://gitlab.com/guifi-exo/wiki/-/blob/master/howto/VMs-procedures/debian.md#legacy-guide-for-iptables

---

#### seguridad (3/3): privelege escalation

https://docs.docker.com/engine/security/rootless/

o usar podman de redhat:

Podman is a daemonless container engine for developing, managing, and running OCI Containers on your Linux System. Containers can either be run as root or in rootless mode. Simply put: `alias docker=podman`

[parece que podman ya funciona con docker-compose](https://www.redhat.com/sysadmin/podman-docker-compose)

---

#### instalar docker

```
apt install docker.io
apt install python3-pip
pip3 install docker-compose
```

recomendaciones adicionales (mochila):

```
apt install nginx iptables-persistent tcpdump curl
```

---

#### comandos de interés (1/2)

- `docker ps`: procesos en ejecución
    - nota: tres primeros carácteres de `dockerID` nos sirven para otros comandos
- `docker ps -a`: enseña contenedores que finalizaron
- `docker inspect dockerID | less`: 
- `docker images`: imágenes guardadas
    - cuidado con espacio en `/var/lib/docker`
    - [cuidado con determinados filesystems](https://docs.docker.com/storage/storagedriver/select-storage-driver/)

---

#### comandos de interés (2/2)

- `docker rm $(docker ps -a -q)`: borra todos los contenedores instanciados
- `docker rmi $(docker images -q -f "dangling=true")`: borra imágenes en desuso
- `docker volume ls`: consulta volúmenes en marcha
- `docker exec -it <dockerID> bash`: arranca (si está disponible) intérprete bash dentro de dicho proceso docker
- `docker logs <dockerID> | less`: inspeccionar logs
